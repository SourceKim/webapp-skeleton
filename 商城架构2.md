# 购物车与订单模块设计

## 数据库设计

### 用户地址表（user_addresses）

| 字段名      | 类型     | 数据库类型                              | 可否为空      | 主键/外键       | 描述         | 示例数据            |
| ------------- | ---------- | ----------------------------------------- | --------------- | ----------------- | -------------- | --------------------- |
| id          | string   | VARCHAR(36)                             | 否            | 主键            | 地址ID       | addr_abc123         |
| user_id     | string   | VARCHAR(36)                             | 否            | 外键→users(id) | 用户ID       | u_abc123            |
| name        | string   | VARCHAR(50)                             | 否            |                 | 收货人姓名   | 张三                |
| phone       | string   | VARCHAR(20)                             | 否            |                 | 手机号码     | 13800138000         |
| province    | string   | VARCHAR(50)                             | 否            |                 | 省份         | 广东省              |
| city        | string   | VARCHAR(50)                             | 否            |                 | 城市         | 深圳市              |
| district    | string   | VARCHAR(50)                             | 否            |                 | 区县         | 南山区              |
| detail      | string   | VARCHAR(200)                            | 否            |                 | 详细地址     | 科技园南区1栋101室  |
| postal_code | string   | VARCHAR(10)                             | 是            |                 | 邮政编码     | 518000              |
| is_default  | boolean  | BOOLEAN                                 | 否(默认false) |                 | 是否默认地址 | true                |
| tag         | enum     | ENUM('HOME','COMPANY','SCHOOL','OTHER') | 是            |                 | 地址标签     | HOME                |
| status      | enum     | ENUM('ACTIVE','INACTIVE')               | 否            |                 | 状态         | ACTIVE              |
| created_at  | datetime | DATETIME                                | 否            |                 | 创建时间     | 2025-10-28 10:00:00 |
| updated_at  | datetime | DATETIME                                | 否            |                 | 更新时间     | 2025-10-28 10:05:00 |
| deleted_at  | datetime | DATETIME                                | 是            |                 | 软删除时间   | null                |

### 购物车表（cart）

| 字段名     | 类型     | 数据库类型  | 可否为空     | 主键/外键             | 描述       | 示例数据            |
| ------------ | ---------- | ------------- | -------------- | ----------------------- | ------------ | --------------------- |
| id         | string   | VARCHAR(36) | 否           | 主键                  | 购物车项ID | cart_abc123         |
| user_id    | string   | VARCHAR(36) | 否           | 外键→users(id)       | 用户ID     | u_abc123            |
| sku_id     | string   | VARCHAR(36) | 否           | 外键→product_sku(id) | SKU ID     | sku_abc123          |
| quantity   | number   | INT         | 否           |                       | 数量       | 2                   |
| selected   | boolean  | BOOLEAN     | 否(默认true) |                       | 是否选中   | true                |
| created_at | datetime | DATETIME    | 否           |                       | 创建时间   | 2025-10-28 10:00:00 |
| updated_at | datetime | DATETIME    | 否           |                       | 更新时间   | 2025-10-28 10:05:00 |

### 订单表（orders）

| 字段名          | 类型     | 数据库类型                                         | 可否为空  | 主键/外键       | 描述       | 示例数据                                                                                                                               |
| ----------------- | ---------- | ---------------------------------------------------- | ----------- | ----------------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------- |
| id              | string   | VARCHAR(36)                                        | 否        | 主键            | 订单ID     | order_abc123                                                                                                                           |
| order_no        | string   | VARCHAR(100)                                       | 否(唯一)  |                 | 订单号     | 202510281000001                                                                                                                        |
| user_id         | string   | VARCHAR(36)                                        | 否        | 外键→users(id) | 用户ID     | u_abc123                                                                                                                               |
| total_amount    | decimal  | DECIMAL(10,2)                                      | 否        |                 | 订单总金额 | 11998.00                                                                                                                               |
| discount_amount | decimal  | DECIMAL(10,2)                                      | 是(默认0) |                 | 折扣金额   | 0.00                                                                                                                                   |
| shipping_amount | decimal  | DECIMAL(10,2)                                      | 是(默认0) |                 | 运费       | 0.00                                                                                                                                   |
| payable_amount  | decimal  | DECIMAL(10,2)                                      | 否        |                 | 应付金额   | 11998.00                                                                                                                               |
| payment_method  | enum     | ENUM('ALIPAY','WECHAT','CASH')                     | 是        |                 | 支付方式   | ALIPAY                                                                                                                                 |
| payment_status  | enum     | ENUM('UNPAID','PAID','REFUNDED')                   | 否        |                 | 支付状态   | UNPAID                                                                                                                                 |
| payment_time    | datetime | DATETIME                                           | 是        |                 | 支付时间   | null                                                                                                                                   |
| **address_id**                | **string**         | VARCHAR(36)                                        | **否**          | **外键→user_addresses(id)**                | 收货地址**ID**   | **addr_abc123**                                                                                                                                       |
| **address_snapshot**                | **json**         | **JSON**                                                   | **否**          |                 | **地址快照**           | {"name": "张三", "phone": "13800138000", "province": "广东省", "city": "深圳市", "district": "南山区", "detail": "科技园南区1栋101室"} |
| delivery_status | enum     | ENUM('PENDING','SHIPPED','DELIVERED')              | 否        |                 | 配送状态   | PENDING                                                                                                                                |
| delivery_time   | datetime | DATETIME                                           | 是        |                 | 发货时间   | null                                                                                                                                   |
| received_time   | datetime | DATETIME                                           | 是        |                 | 收货时间   | null                                                                                                                                   |
| order_status    | enum     | ENUM('PENDING','CONFIRMED','CANCELED','COMPLETED') | 否        |                 | 订单状态   | PENDING                                                                                                                                |
| remark          | string   | VARCHAR(500)                                       | 是        |                 | 订单备注   | 请尽快发货                                                                                                                             |
| created_at      | datetime | DATETIME                                           | 否        |                 | 创建时间   | 2025-10-28 10:00:00                                                                                                                    |
| updated_at      | datetime | DATETIME                                           | 否        |                 | 更新时间   | 2025-10-28 10:05:00                                                                                                                    |
| deleted_at      | datetime | DATETIME                                           | 是        |                 | 软删除时间 | null                                                                                                                                   |

### 订单商品项表（order_items）

| 字段名       | 类型     | 数据库类型    | 可否为空 | 主键/外键             | 描述     | 示例数据                                                                                         |
| -------------- | ---------- | --------------- | ---------- | ----------------------- | ---------- | -------------------------------------------------------------------------------------------------- |
| id           | string   | VARCHAR(36)   | 否       | 主键                  | 订单项ID | order_item_abc123                                                                                |
| order_id     | string   | VARCHAR(36)   | 否       | 外键→orders(id)      | 订单ID   | order_abc123                                                                                     |
| sku_id       | string   | VARCHAR(36)   | 否       | 外键→product_sku(id) | SKU ID   | sku_abc123                                                                                       |
| sku_snapshot | json     | JSON          | 否       |                       | SKU快照  | {"name": "智能手机 黑色 128G", "price": 5999.00, "attributes": {"颜色": "黑色", "内存": "128G"}} |
| quantity     | number   | INT           | 否       |                       | 数量     | 2                                                                                                |
| unit_price   | decimal  | DECIMAL(10,2) | 否       |                       | 单价     | 5999.00                                                                                          |
| total_price  | decimal  | DECIMAL(10,2) | 否       |                       | 总价     | 11998.00                                                                                         |
| created_at   | datetime | DATETIME      | 否       |                       | 创建时间 | 2025-10-28 10:00:00                                                                              |
| updated_at   | datetime | DATETIME      | 否       |                       | 更新时间 | 2025-10-28 10:05:00                                                                              |

## API设计

### 用户地址API

| 路由路径 | 方法   | 描述             | 权限   | 请求参数 | 响应数据     |
| ---------- | -------- | ------------------ | -------- | ---------- | -------------- |
| `/api/v1/addresses`         | GET    | 获取用户地址列表 | 需登录 | 无       | 地址列表     |
| `/api/v1/addresses/:id`         | GET    | 获取地址详情     | 需登录 | 无       | 地址详情     |
| `/api/v1/addresses`         | POST   | 创建地址         | 需登录 | 地址参数 | 创建的地址   |
| `/api/v1/addresses/:id`         | PUT    | 更新地址         | 需登录 | 地址参数 | 更新后的地址 |
| `/api/v1/addresses/:id`         | DELETE | 删除地址         | 需登录 | 无       | 无           |
| `/api/v1/addresses/:id/default`         | PUT    | 设为默认地址     | 需登录 | 无       |              |

### 购物车API（用户端）

| 路由路径 | 方法   | 描述               | 权限   | 请求参数 | 响应数据         |
| ---------- | -------- | -------------------- | -------- | ---------- | ------------------ |
| `/api/v1/cart`         | GET    | 获取购物车列表     | 需登录 | 无       | 购物车项列表     |
| `/api/v1/cart`         | POST   | 添加商品到购物车   | 需登录 | `{ sku_id: "xxx", quantity: 1 }`         | 添加的购物车项   |
| `/api/v1/cart/:id`         | PUT    | 更新购物车商品数量 | 需登录 | `{ quantity: 2 }`         | 更新后的购物车项 |
| `/api/v1/cart/:id`         | DELETE | 删除购物车商品     | 需登录 | 无       | 无               |
| `/api/v1/cart/selected`         | PUT    | 批量更新选中状态   | 需登录 | `{ selected: true, cart_item_ids: ["id1", "id2"] }`         | 无               |

### 订单API（用户端）

| 路由路径 | 方法 | 描述         | 权限   | 请求参数    | 响应数据     |
| ---------- | ------ | -------------- | -------- | ------------- | -------------- |
| `/api/v1/orders`         | GET  | 获取订单列表 | 需登录 | `page`, `size`, `status` (可选) | 订单列表     |
| `/api/v1/orders/:id`         | GET  | 获取订单详情 | 需登录 | 无          | 订单详情     |
| `/api/v1/orders`         | POST | 创建订单     | 需登录 | `{ cart_item_ids: ["id1", "id2"], shipping_address: {...}, remark: "..." }`            | 创建的订单   |
| `/api/v1/orders/:id/cancel`         | PUT  | 取消订单     | 需登录 | 无          | 取消后的订单 |
| `/api/v1/orders/:id/pay`         | POST | 支付订单     | 需登录 | 无          | 支付信息     |
| `/api/v1/orders/preview`         | POST | 订单预览     | 需登录 | `{ cart_item_ids: ["id1", "id2"] }`            | 订单预览信息 |

### 订单管理API（管理端）

| 路由路径 | 方法   | 描述             | 权限   | 请求参数                   | 响应数据     |
| ---------- | -------- | ------------------ | -------- | ---------------------------- | -------------- |
| `/api/v1/admin/orders`         | GET    | 订单列表（分页） | 管理员 | `page`, `size`, `order_status`, `payment_status`, `delivery_status`等                 | 订单列表     |
| `/api/v1/admin/orders/:id`         | GET    | 获取订单详情     | 管理员 | 无                         | 订单详情     |
| `/api/v1/admin/orders/:id`         | PUT    | 更新订单         | 管理员 | 可更新订单状态、配送状态等 | 更新后的订单 |
| `/api/v1/admin/orders/:id`         | DELETE | 删除订单         | 管理员 | 无                         | 无           |
| `/api/v1/admin/orders/:id/ship`         | PUT    | 发货操作         | 管理员 | `{ delivery_company: "顺丰", tracking_number: "123456" }`                           | 发货后的订单 |

## 页面与交互

### 应用端

#### 地址管理页面 (`/addresses`)

| 用户操作       | 页面反馈     | API调用 | 请求数据 | 响应处理                       |
| ---------------- | -------------- | --------- | ---------- | -------------------------------- |
| 页面加载       | 显示地址列表 | `GET /api/v1/addresses`        | 无       | 渲染地址卡片列表，标记默认地址 |
| 点击"新增地址" | 弹出地址表单 | 无      | 无       | 显示空表单等待输入             |
| 填写地址表单   | 实时表单验证 | 无      | 无       | 检查必填字段，显示错误提示     |
| 点击"保存"     | 保存地址     | `POST /api/v1/addresses`        | `{name: "张三", phone: "13800138000", province: "广东省", city: "深圳市", district: "南山区", detail: "科技园1栋", is_default: true}`         | 保存成功，刷新地址列表         |
| 点击地址编辑   | 弹出预填表单 | `GET /api/v1/addresses/:id`        | 无       | 用地址数据填充表单             |
| 点击地址删除   | 确认删除     | `DELETE /api/v1/addresses/:id`        | 无       | 删除成功，从列表移除           |
| 点击"设为默认" | 设置默认地址 | `PUT /api/v1/addresses/:id/default`        | 无       |                                |

- 在「我的」tab 中增加地址管理入口
- 地址列表使用 https://nutui.jd.com/taro/vue/4x/#/zh-CN/component/addresslist 组件渲染
- 地址表单使用 https://nutui.jd.com/taro/vue/4x/#/zh-CN/component/address 实现

#### 购物车页面 (`/cart`)

| 用户操作     | 页面反馈       | API调用 | 请求数据 | 响应处理                                   |
| -------------- | ---------------- | --------- | ---------- | -------------------------------------------- |
| 页面加载     | 显示购物车列表 | `GET /api/v1/cart`        | 无       | 渲染购物车商品，包含图片、名称、属性、价格 |
| 点击选择框   | 更新选中状态   | `PUT /api/v1/cart/selected`        | `{selected: true, cart_item_ids: ["cart1"]}`         | 重新计算总价，更新选中状态                 |
| 点击数量"+"  | 增加数量       | `PUT /api/v1/cart/:id`        | `{quantity: 新数量}`         | 数量增加，更新小计和总价                   |
| 点击数量"-"  | 减少数量       | `PUT /api/v1/cart/:id`        | `{quantity: 新数量}`         | 数量减少，更新小计和总价                   |
| 直接输入数量 | 更新数量       | `PUT /api/v1/cart/:id`        | `{quantity: 输入值}`         | 数量更新，验证库存                         |
| 点击删除     | 确认删除       | `DELETE /api/v1/cart/:id`        | 无       | 从购物车移除商品                           |
| 点击全选     | 全选/全不选    | `PUT /api/v1/cart/selected`        | `{selected: true, cart_item_ids: 所有ID}`         | 所有商品选中状态切换                       |
| 点击结算     | 跳转订单页     | 无      | 无       | 携带选中商品跳转到订单确认                 |

- 以下这些页面的 nav 中，右侧增加一个跳转到购物车的按钮：

  - 「选择品牌」
  - 「商城」

#### 订单确认页面 (`/order/confirm`)

| 用户操作     | 页面反馈     | API调用 | 请求数据 | 响应处理                     |
| -------------- | -------------- | --------- | ---------- | ------------------------------ |
| 页面加载     | 显示订单预览 | `POST /api/v1/orders/preview`        | `{cart_item_ids: ["cart1", "cart2"]}`         | 显示商品列表、总价、运费等   |
| 选择收货地址 | 更新地址信息 | 无      | 无       | 更新订单地址显示             |
| 选择支付方式 | 更新支付方式 | 无      | 无       | 显示选择的支付方式           |
| 点击提交订单 | 创建订单     | `POST /api/v1/orders`        | `{cart_item_ids: [...], shipping_address: {...}, payment_method: "ALIPAY"}`         | 创建订单成功，跳转到支付页面 |
| 点击修改商品 | 返回购物车   | 无      | 无       | 返回购物车页面修改           |

#### 订单列表页面 (`/orders`)

| 用户操作     | 页面反馈     | API调用 | 请求数据 | 响应处理           |
| -------------- | -------------- | --------- | ---------- | -------------------- |
| 页面加载     | 显示订单列表 | `GET /api/v1/orders?page=1&size=10`        | 无       | 渲染订单卡片列表   |
| 选择状态筛选 | 重新加载     | `GET /api/v1/orders?status=PENDING`        | 无       | 显示对应状态订单   |
| 点击订单卡片 | 跳转详情     | 无      | 无       | 跳转到订单详情页面 |
| 点击去支付   | 跳转支付     | `POST /api/v1/orders/:id/pay`        | 无       | 跳转到支付页面     |
| 点击取消订单 | 确认取消     | `PUT /api/v1/orders/:id/cancel`        | 无       | 订单状态变为取消   |
| 点击确认收货 | 确认收货     | `PUT /api/v1/orders/:id/receive`        | 无       | 订单状态变为完成   |

- 状态筛选使用 https://nutui.jd.com/taro/vue/4x/#/zh-CN/component/tabs 组件实现
- 订单卡片的订单状态使用 https://nutui.jd.com/taro/vue/4x/#/zh-CN/component/tag 实现
- 在「我的」tab 中增加一排按钮组，分别用以跳转到「全部订单」，「待支付」，「待发货」，「已完成」

#### 订单详情页面 (`/orders/:id`)

| 用户操作 | 页面反馈     | API调用 | 请求数据 | 响应处理         |
| ---------- | -------------- | --------- | ---------- | ------------------ |
| 页面加载 | 显示订单详情 | `GET /api/v1/orders/:id`        | 无       | 渲染订单完整信息 |

- 使用「步骤条」组件渲染订单状态 https://nutui.jd.com/taro/vue/4x/#/zh-CN/component/steps

### 管理端

#### 地址管理页面 (`/admin/orders`)

| 用户操作 | 页面反馈     | API调用 | 请求数据 |
| ---------- | -------------- | --------- | ---------- |
| 页面加载 | 显示地址列表 | `GET /api/v1/admin/orders?page=1&size=20`        | 无       |

#### 订单管理页面 (`/admin/orders`)

| 用户操作     | 页面反馈     | API调用 | 请求数据     | 响应处理               |
| -------------- | -------------- | --------- | -------------- | ------------------------ |
| 页面加载     | 显示订单列表 | `GET /api/v1/admin/orders?page=1&size=20`        | 无           | 渲染订单表格           |
| 选择状态筛选 | 重新加载     | `GET /api/v1/admin/orders?order_status=PENDING`        | 无           | 过滤显示对应状态订单   |
| 点击订单行   | 显示详情     | `GET /api/v1/admin/orders/:id`        | 无           | 在侧边栏或弹窗显示详情 |
| 点击发货     | 弹出发货表单 | 无      | 无           | 显示发货信息填写表单   |
| 确认发货     | 更新订单状态 | `PUT /api/v1/admin/orders/:id/ship`        | `{delivery_company: "顺丰", tracking_number: "123456"}`             | 订单状态更新为已发货   |
| 点击修改订单 | 弹出编辑表单 | `GET /api/v1/admin/orders/:id`        | 无           | 显示订单编辑表单       |
| 确认修改     | 更新订单     | `PUT /api/v1/admin/orders/:id`        | 订单更新数据 | 订单信息更新           |
| 点击删除     | 确认删除     | `DELETE /api/v1/admin/orders/:id`        | 无           | 订单软删除             |

#### 订单详情页面 (`/admin/orders/:id`)

| 用户操作     | 页面反馈         | API调用 | 请求数据 | 响应处理             |
| -------------- | ------------------ | --------- | ---------- | ---------------------- |
| 页面加载     | 显示完整订单信息 | `GET /api/v1/admin/orders/:id`        | 无       | 渲染订单所有详细信息 |
| 查看商品快照 | 显示商品详情     | 无      | 无       | 展示下单时的商品信息 |
| 修改订单状态 | 状态选择         | `PUT /api/v1/admin/orders/:id`        | `{order_status: "CONFIRMED"}`         | 订单状态更新         |
| 修改支付状态 | 状态选择         | `PUT /api/v1/admin/orders/:id`        | `{payment_status: "PAID"}`         | 支付状态更新         |
| 修改配送状态 | 状态选择         | `PUT /api/v1/admin/orders/:id`        | `{delivery_status: "SHIPPED"}`         | 配送状态更新         |
| 添加订单备注 | 保存备注         | `PUT /api/v1/admin/orders/:id`        | `{remark: "新备注"}`         | 订单备注更新         |

## 关键业务流程

### 1. 加入购物车流程

```
用户操作: 在商品详情页点击"加入购物车"
前端处理:
  1. 验证属性选择完整
  2. 获取当前选中的SKU ID
  3. 检查本地购物车是否已有该SKU
  4. 调用: POST /api/v1/cart
  5. 请求数据: {sku_id: "xxx", quantity: 1} （按照标准数据请求）
  6. 成功: 显示"已加入购物车"，更新购物车徽章
  7. 失败: 显示错误信息（库存不足等）
```

### 2. 创建订单流程

```
用户操作: 在购物车点击"结算"或在商品详情页点击"立即购买"
前端处理:
  1. 验证选中商品和收货信息
  2. 调用: POST /api/v1/orders/preview (预览)
  3. 显示订单确认页面，用户确认信息
  4. 调用: POST /api/v1/orders (创建订单)
  5. 后端处理:
     - 验证商品库存
     - 锁定库存
     - 生成订单号
     - 保存订单和订单项（包含商品快照）
     - 清理购物车选中商品
  6. 创建成功: 跳转到支付页面
  7. 创建失败: 显示错误信息
```

### 3. 订单状态流转

```
PENDING (待支付) 
  → 用户支付 → PAID (已支付) 
  → 管理员发货 → SHIPPED (已发货) 
  → 用户收货 → COMPLETED (已完成)
  
PENDING (待支付) 
  → 用户取消/超时取消 → CANCELED (已取消)
```